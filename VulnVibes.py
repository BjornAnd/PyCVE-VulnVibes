import tkinter as tk
from tkinter import messagebox
import requests
import matplotlib.pyplot as plt

# Function to be called when the button is pressed
def on_button_click():
    user_input = entry.get()
    user_input = "CVE-2024-7593"  # Hardcoded for testing
    if user_input:
        api_url = f"https://api.first.org/data/v1/epss?cve={user_input}&scope=time-series"        
        try:
            response = requests.get(api_url)
            response.raise_for_status()  # Raise an error for bad status codes
            data = response.json()
#            messagebox.showinfo("Input", f"the response: {data}")
            
            # Extract main data
            main_data = data['data'][0]
            main_date = main_data['date']
            main_epss = float(main_data['epss'])
            
            # Extract time-series data
            time_series = main_data['time-series']
            time_series_dates = [item['date'] for item in time_series]
            time_series_epss_scores = [float(item['epss']) for item in time_series]
            
            # Combine main data and time-series data
            dates = [main_date] + time_series_dates
            epss_scores = [main_epss] + time_series_epss_scores
            
            # Plot the data
            plt.figure(figsize=(7, 5))
            plt.xlabel('Date')
            plt.ylabel('EPSS Score')
            plt.ylim(0, 1)
            plt.yticks([i * 0.1 for i in range(11)])  # Set Y-axis ticks from 0 to 1 at intervals of 0.1
            plt.axhline(0, color='black', linewidth=0.5)  # Add a horizontal line at Y=0
            plt.title(f'EPSS Scores for {user_input}')
            plt.grid(True)
            plt.xticks(rotation=90)
            plt.gca().invert_xaxis()  # Invert the X-axis
            # plt.tight_layout()
            plt.plot(dates, epss_scores, marker='o')
            plt.show()
            
        except requests.exceptions.RequestException as e:
            messagebox.showerror("Error", f"API request failed: {e}")
    else:
        messagebox.showwarning("Input Error", "Please enter a CVE identifier.")


# Create the main application window
root = tk.Tk()
root.title("VulnVibes")

# Set the window size
root.geometry("400x300")

# Create an input field
entry = tk.Entry(root)
entry.pack(pady=10)

# Create a button
button = tk.Button(root, text="Enter CVE (format: 'CVE-YYYY-#####')", command=on_button_click)
button.pack(pady=10)

# Run the main event loop
root.mainloop()